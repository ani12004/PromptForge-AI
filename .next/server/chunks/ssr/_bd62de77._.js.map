{"version":3,"sources":["../../../../lib/supabaseClient.ts","../../../../app/actions/subscription.ts","../../../../app/actions/auth.ts","../../../../node_modules/%40clerk/nextjs/dist/esm/app-router/server-actions.js","../../../../.next-internal/server/app/admin/page/actions.js%20%28server%20actions%20loader%29","../../../../app/admin/actions.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\"\r\n\r\n/**\r\n * Creates a Supabase client authenticated with the user's Clerk session.\r\n * \r\n * @param clerkToken - The JWT token from Clerk (await getToken({ template: 'supabase' }))\r\n */\r\nexport const createClerkSupabaseClient = (clerkToken?: string | null) => {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\n    return createClient(supabaseUrl, supabaseKey, {\r\n        global: {\r\n            headers: clerkToken ? { Authorization: `Bearer ${clerkToken}` } : undefined,\r\n        },\r\n    })\r\n}\r\n","\"use server\";\r\n\r\nimport { auth } from \"@clerk/nextjs/server\";\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\";\r\n\r\nexport async function getUserSubscription() {\r\n    try {\r\n        const { userId, getToken } = await auth();\r\n        if (!userId) return \"free\";\r\n\r\n        const token = await getToken({ template: \"supabase\" });\r\n        const supabase = createClerkSupabaseClient(token);\r\n\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('subscription_tier')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        return (profile?.subscription_tier || \"free\").toLowerCase();\r\n    } catch (error) {\r\n        console.error(\"Error fetching subscription:\", error);\r\n        return \"free\";\r\n    }\r\n}\r\n","\"use server\"\r\n\r\nimport { auth } from \"@clerk/nextjs/server\"\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\"\r\n\r\nexport async function getUserRole() {\r\n    const { userId, getToken } = await auth()\r\n\r\n    if (!userId) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = await getToken({ template: \"supabase\" })\r\n        const supabase = createClerkSupabaseClient(token)\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('role')\r\n            .eq('id', userId)\r\n            .single()\r\n\r\n        return profile?.role || 'user'\r\n    } catch (error) {\r\n        console.error(\"Failed to fetch user role\", error)\r\n        return 'user'\r\n    }\r\n}\r\n","\"use server\";\nimport { cookies } from \"next/headers\";\nasync function invalidateCacheAction() {\n  void (await cookies()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`);\n}\nexport {\n  invalidateCacheAction\n};\n","export {getUserSubscription as '0003a3dcf615081a16c914805a79b1208e05658d88'} from 'ACTIONS_MODULE0'\nexport {getUserRole as '0051101ac87c471b7462d604cadbab8a2e54996392'} from 'ACTIONS_MODULE1'\nexport {detectKeylessEnvDriftAction as '00d33c04adba09f9320585b6cd2442fddc67121317'} from 'ACTIONS_MODULE2'\nexport {invalidateCacheAction as '00fb695b95eb42dc75b9b2e7e86571a2d3342b32bb'} from 'ACTIONS_MODULE3'\nexport {createOrReadKeylessAction as '000c5950602641cd8b0661a788cb4fb705def1b4b1'} from 'ACTIONS_MODULE2'\nexport {collectKeylessMetadata as '008a5782a58bd8eba0077f5b1e478761fed9d410df'} from 'ACTIONS_MODULE4'\nexport {formatMetadataHeaders as '40e8dbb7737be346be89256c32890a354586b96faf'} from 'ACTIONS_MODULE4'\nexport {createOrReadKeylessAction as '000c5950602641cd8b0661a788cb4fb705def1b4b1'} from 'ACTIONS_MODULE2'\nexport {deleteKeylessAction as '0064afb0bd84c5266927f4777c8f0ddd5c7e626c6a'} from 'ACTIONS_MODULE2'\nexport {detectKeylessEnvDriftAction as '00d33c04adba09f9320585b6cd2442fddc67121317'} from 'ACTIONS_MODULE2'\nexport {syncKeylessConfigAction as '40efc55e4105d4adbc9874f14cc1c800be70aff8bc'} from 'ACTIONS_MODULE2'\nexport {syncKeylessConfigAction as '40efc55e4105d4adbc9874f14cc1c800be70aff8bc'} from 'ACTIONS_MODULE2'\nexport {deleteKeylessAction as '0064afb0bd84c5266927f4777c8f0ddd5c7e626c6a'} from 'ACTIONS_MODULE2'\nexport {getAdminStats as '00b097554662331b18367ba80cd05ccb530331738b'} from 'ACTIONS_MODULE5'\nexport {getUsers as '008c60efefc397f629252e2ed7eb0e8e19e03a7c1a'} from 'ACTIONS_MODULE5'\nexport {getContactMessages as '00ccf8bd70c4ef8697da5158f290d1f1fa493c258d'} from 'ACTIONS_MODULE5'\nexport {sendBroadcastNotification as '60b927a94dbbb997de4c477625b6eddf66d4916cff'} from 'ACTIONS_MODULE5'\nexport {updateMessageStatus as '602d86472a27033ecc9fd12e36af4ff1db69022ce5'} from 'ACTIONS_MODULE5'\nexport {sendEmailReply as '783f3bdbbc3344bd200d335c9a9c1e57a1120fc975'} from 'ACTIONS_MODULE5'\n","\"use server\"\r\n\r\nimport { createAdminClient } from \"@/lib/supabaseAdmin\"\r\nimport { isAdmin } from \"@/lib/admin\"\r\n// Resend import removed as we are switching to In-App Notifications\r\n\r\n// Helper to ensure admin access\r\nasync function checkAdmin() {\r\n    const isAllowed = await isAdmin()\r\n    if (!isAllowed) {\r\n        throw new Error(\"Unauthorized Access\")\r\n    }\r\n}\r\n\r\nexport async function getAdminStats() {\r\n    await checkAdmin()\r\n    const supabase = createAdminClient()\r\n\r\n    const { count: totalUsers, error: usersError } = await supabase\r\n        .from('profiles')\r\n        .select('*', { count: 'exact', head: true })\r\n\r\n    const { count: totalMessages, error: messagesError } = await supabase\r\n        .from('contact_messages')\r\n        .select('*', { count: 'exact', head: true })\r\n\r\n    const { count: unreadMessages, error: unreadError } = await supabase\r\n        .from('contact_messages')\r\n        .select('*', { count: 'exact', head: true })\r\n        .eq('status', 'unread')\r\n\r\n    if (usersError || messagesError || unreadError) {\r\n        console.error(\"Error fetching stats\", usersError, messagesError, unreadError)\r\n        return { totalUsers: 0, totalMessages: 0, unreadMessages: 0 }\r\n    }\r\n\r\n    return {\r\n        totalUsers: totalUsers || 0,\r\n        totalMessages: totalMessages || 0,\r\n        unreadMessages: unreadMessages || 0\r\n    }\r\n}\r\n\r\nexport async function getUsers() {\r\n    await checkAdmin()\r\n    const supabase = createAdminClient()\r\n\r\n    const { data, error } = await supabase\r\n        .from('profiles')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n        .limit(100)\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching users\", error)\r\n        return []\r\n    }\r\n    return data\r\n}\r\n\r\nexport async function getContactMessages() {\r\n    await checkAdmin()\r\n    const supabase = createAdminClient()\r\n\r\n    const { data, error } = await supabase\r\n        .from('contact_messages')\r\n        .select('*')\r\n        .order('created_at', { ascending: false })\r\n        .limit(100)\r\n\r\n    if (error) {\r\n        console.error(\"Error fetching messages\", error)\r\n        return []\r\n    }\r\n    return data\r\n}\r\n\r\n// Renamed to generic \"broadcast\" since we now use notifications\r\nexport async function sendBroadcastNotification(prevState: any, formData: FormData) {\r\n    await checkAdmin()\r\n    const supabase = createAdminClient()\r\n\r\n    const subject = formData.get(\"subject\") as string\r\n    const message = formData.get(\"message\") as string\r\n\r\n    if (!subject || !message) {\r\n        return { error: \"Title and Message are required\" }\r\n    }\r\n\r\n    // Insert Global Notification (user_id = null)\r\n    const { error } = await supabase\r\n        .from('notifications')\r\n        .insert({\r\n            title: subject,\r\n            message: message,\r\n            type: 'info',\r\n            user_id: null // Global\r\n        })\r\n\r\n    if (error) {\r\n        console.error(\"Failed to create notification\", error)\r\n        return { error: \"Failed to publish notification\" }\r\n    }\r\n\r\n    return {\r\n        success: true,\r\n        message: \"Notification published to all users.\"\r\n    }\r\n}\r\n\r\nexport async function updateMessageStatus(id: string, status: 'read' | 'unread') {\r\n    await checkAdmin()\r\n    const supabase = createAdminClient()\r\n\r\n    const { error } = await supabase\r\n        .from('contact_messages')\r\n        .update({ status })\r\n        .eq('id', id)\r\n\r\n    if (error) {\r\n        console.error(\"Error updating message status\", error)\r\n        return { error: \"Failed to update status\" }\r\n    }\r\n\r\n    return { success: true }\r\n}\r\n\r\nimport { Resend } from 'resend';\r\n\r\nconst resend = new Resend(process.env.RESEND_API_KEY);\r\n\r\nexport async function sendEmailReply(to: string, subject: string, message: string, replyContent: string) {\r\n    await checkAdmin()\r\n\r\n    if (!process.env.RESEND_API_KEY) {\r\n        return { error: \"RESEND_API_KEY is missing\" }\r\n    }\r\n\r\n    try {\r\n        const { data, error } = await resend.emails.send({\r\n            from: 'PromptForge AI <admin@promptforgeai.com>', // Update this if user has custom domain\r\n            to: [to],\r\n            // Ensure subject starts with Re: if not present\r\n            subject: subject.startsWith('Re:') ? subject : `Re: ${subject}`,\r\n            html: `\r\n            <!DOCTYPE html>\r\n            <html>\r\n            <head>\r\n                <style>\r\n                    body { font-family: 'Inter', sans-serif; background-color: #000000; color: #ffffff; margin: 0; padding: 0; }\r\n                    .container { max-width: 600px; margin: 0 auto; padding: 20px; background-color: #18181b; border: 1px solid #333; border-radius: 12px; margin-top: 40px; }\r\n                    .header { text-align: center; padding-bottom: 20px; border-bottom: 1px solid #333; margin-bottom: 20px; }\r\n                    .logo { height: 40px; }\r\n                    .content { font-size: 16px; line-height: 1.6; color: #e5e7eb; }\r\n                    .quote { margin-top: 20px; padding: 15px; background-color: #27272a; border-left: 4px solid #8b5cf6; color: #9ca3af; font-size: 14px; border-radius: 4px; }\r\n                    .footer { margin-top: 30px; text-align: center; font-size: 12px; color: #6b7280; border-top: 1px solid #333; padding-top: 20px; }\r\n                </style>\r\n            </head>\r\n            <body>\r\n                <div class=\"container\">\r\n                    <div class=\"header\">\r\n                         <!-- Assuming public folder is served at root domain. If not, user needs updates -->\r\n                        <img src=\"${process.env.NEXT_PUBLIC_APP_URL || 'https://promptforge.ai'}/logo_navi.png\" alt=\"PromptForge AI\" class=\"logo\" />\r\n                    </div>\r\n                    \r\n                    <div class=\"content\">\r\n                        ${replyContent.replace(/\\n/g, '<br/>')}\r\n                    </div>\r\n\r\n                    <div class=\"quote\">\r\n                        <strong>On ${new Date().toLocaleDateString()}, you wrote:</strong><br/>\r\n                        ${message}\r\n                    </div>\r\n\r\n                    <div class=\"footer\">\r\n                        &copy; ${new Date().getFullYear()} PromptForge AI. All rights reserved.\r\n                    </div>\r\n                </div>\r\n            </body>\r\n            </html>\r\n            `\r\n        });\r\n\r\n        if (error) {\r\n            console.error(\"Resend Error:\", error);\r\n            return { error: error.message };\r\n        }\r\n\r\n        return { success: true };\r\n    } catch (e) {\r\n        console.error(\"Failed to send email:\", e);\r\n        return { error: \"Internal Server Error\" };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[3]}