{"version":3,"sources":["../../../../app/actions/subscription.ts","../../../../app/actions/auth.ts","../../../../node_modules/%40clerk/nextjs/dist/esm/app-router/server-actions.js","../../../../app/actions/analytics.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { auth } from \"@clerk/nextjs/server\";\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\";\r\n\r\nexport async function getUserSubscription() {\r\n    try {\r\n        const { userId, getToken } = await auth();\r\n        if (!userId) return \"free\";\r\n\r\n        const token = await getToken({ template: \"supabase\" });\r\n        const supabase = createClerkSupabaseClient(token);\r\n\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('subscription_tier')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        return (profile?.subscription_tier || \"free\").toLowerCase();\r\n    } catch (error) {\r\n        console.error(\"Error fetching subscription:\", error);\r\n        return \"free\";\r\n    }\r\n}\r\n","\"use server\"\r\n\r\nimport { auth } from \"@clerk/nextjs/server\"\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\"\r\n\r\nexport async function getUserRole() {\r\n    const { userId, getToken } = await auth()\r\n\r\n    if (!userId) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = await getToken({ template: \"supabase\" })\r\n        const supabase = createClerkSupabaseClient(token)\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('role')\r\n            .eq('id', userId)\r\n            .single()\r\n\r\n        return profile?.role || 'user'\r\n    } catch (error) {\r\n        console.error(\"Failed to fetch user role\", error)\r\n        return 'user'\r\n    }\r\n}\r\n","\"use server\";\nimport { cookies } from \"next/headers\";\nasync function invalidateCacheAction() {\n  void (await cookies()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`);\n}\nexport {\n  invalidateCacheAction\n};\n","\"use server\"\r\n\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\"\r\nimport { auth } from \"@clerk/nextjs/server\"\r\n\r\nexport interface DashboardMetrics {\r\n    totalPrompts: number;\r\n    totalTokens: number;\r\n    totalCost: number; // in micro-USD\r\n    avgLatency: number;\r\n    usageOverTime: { date: string, count: number }[];\r\n}\r\n\r\nexport async function submitFeedback(promptVersionId: string, score: number, comment?: string) {\r\n    const { userId, getToken } = await auth();\r\n\r\n    if (!userId) {\r\n        return { success: false, error: \"Unauthorized\" };\r\n    }\r\n\r\n    try {\r\n        const token = await getToken({ template: \"supabase\" });\r\n        const supabase = createClerkSupabaseClient(token);\r\n\r\n        const { data, error } = await supabase\r\n            .from('prompt_analytics')\r\n            .update({\r\n                feedback_score: score,\r\n                feedback_comment: comment\r\n            })\r\n            .eq('prompt_version_id', promptVersionId)\r\n            .eq('user_id', userId)\r\n            .select();\r\n\r\n        if (error) {\r\n            console.error(\"Error submitting feedback:\", error);\r\n            return { success: false, error: error.message };\r\n        }\r\n\r\n        return { success: true };\r\n\r\n    } catch (error) {\r\n        console.error(\"Exception in submitFeedback:\", error);\r\n        return { success: false, error: \"Internal server error\" };\r\n    }\r\n}\r\n\r\nexport async function getDashboardMetrics(): Promise<{ success: boolean, data?: DashboardMetrics, error?: string }> {\r\n    const { userId, getToken } = await auth();\r\n\r\n    if (!userId) {\r\n        return { success: false, error: \"Unauthorized\" };\r\n    }\r\n\r\n    try {\r\n        const token = await getToken({ template: \"supabase\" });\r\n        const supabase = createClerkSupabaseClient(token);\r\n\r\n        // 1. Fetch all analytics for this user\r\n        // Note: For a real production app with millions of rows, use Supabase RPC or materialized views.\r\n        // For now, fetching raw rows is fine (~1000s of rows).\r\n        const { data, error } = await supabase\r\n            .from('prompt_analytics')\r\n            .select('created_at, tokens_input, tokens_output, latency_ms, cost_micro_usd')\r\n            .eq('user_id', userId)\r\n            .order('created_at', { ascending: true });\r\n\r\n        if (error) {\r\n            console.error(\"Error fetching analytics:\", error);\r\n            return { success: false, error: error.message };\r\n        }\r\n\r\n        if (!data || data.length === 0) {\r\n            return {\r\n                success: true,\r\n                data: {\r\n                    totalPrompts: 0,\r\n                    totalTokens: 0,\r\n                    totalCost: 0,\r\n                    avgLatency: 0,\r\n                    usageOverTime: []\r\n                }\r\n            };\r\n        }\r\n\r\n        // 2. Aggregate Data in JS (Client-side logic on server)\r\n        let totalTokens = 0;\r\n        let totalCost = 0;\r\n        let totalLatency = 0;\r\n\r\n        // Group by date (YYYY-MM-DD)\r\n        const dailyCounts: Record<string, number> = {};\r\n\r\n        data.forEach(row => {\r\n            totalTokens += (row.tokens_input || 0) + (row.tokens_output || 0);\r\n            totalCost += (row.cost_micro_usd || 0);\r\n            totalLatency += (row.latency_ms || 0);\r\n\r\n            const date = new Date(row.created_at).toISOString().split('T')[0];\r\n            dailyCounts[date] = (dailyCounts[date] || 0) + 1;\r\n        });\r\n\r\n        const avgLatency = Math.round(totalLatency / data.length);\r\n\r\n        // Convert map to array and sort\r\n        const usageOverTime = Object.entries(dailyCounts)\r\n            .map(([date, count]) => ({ date, count }))\r\n            .sort((a, b) => a.date.localeCompare(b.date));\r\n\r\n        return {\r\n            success: true,\r\n            data: {\r\n                totalPrompts: data.length,\r\n                totalTokens,\r\n                totalCost,\r\n                avgLatency,\r\n                usageOverTime\r\n            }\r\n        };\r\n\r\n    } catch (error) {\r\n        console.error(\"Exception in getDashboardMetrics:\", error);\r\n        return { success: false, error: \"Internal server error\" };\r\n    }\r\n}\r\n\r\nexport interface TopPrompt {\r\n    id: string; // version id\r\n    promptId: string;\r\n    content: string;\r\n    score: number;\r\n    tokens: number;\r\n    cost: number;\r\n    timestamp: string;\r\n}\r\n\r\nexport async function getTopPrompts(): Promise<{ success: boolean, data?: TopPrompt[], error?: string }> {\r\n    const { userId, getToken } = await auth();\r\n\r\n    if (!userId) return { success: false, error: \"Unauthorized\" };\r\n\r\n    try {\r\n        const token = await getToken({ template: \"supabase\" });\r\n        const supabase = createClerkSupabaseClient(token);\r\n\r\n        // Fetch analytics with high scores\r\n        const { data: analyticsData, error: analyticsError } = await supabase\r\n            .from('prompt_analytics')\r\n            .select('prompt_version_id, feedback_score, tokens_output, cost_micro_usd, created_at')\r\n            .eq('user_id', userId)\r\n            //.eq('feedback_score', 1) // Optional: filter by positive score? Let's just return all for now to debug\r\n            .order('feedback_score', { ascending: false, nullsFirst: false })\r\n            .order('created_at', { ascending: false })\r\n            .limit(5);\r\n\r\n        if (analyticsError) return { success: false, error: analyticsError.message };\r\n\r\n        if (!analyticsData || analyticsData.length === 0) return { success: true, data: [] };\r\n\r\n        // Fetch version content for these\r\n        const versionIds = analyticsData.map(a => a.prompt_version_id);\r\n        const { data: versionsData, error: versionsError } = await supabase\r\n            .from('prompt_versions')\r\n            .select('id, content, prompt_id')\r\n            .in('id', versionIds);\r\n\r\n        if (versionsError) return { success: false, error: versionsError.message };\r\n\r\n        // Map back together\r\n        const topPrompts: TopPrompt[] = analyticsData.map(a => {\r\n            const version = versionsData?.find(v => v.id === a.prompt_version_id);\r\n            return {\r\n                id: a.prompt_version_id,\r\n                promptId: version?.prompt_id || \"\",\r\n                content: version?.content || \"Unknown Prompt\",\r\n                score: a.feedback_score || 0,\r\n                tokens: a.tokens_output || 0,\r\n                cost: a.cost_micro_usd || 0,\r\n                timestamp: a.created_at\r\n            };\r\n        });\r\n\r\n        return { success: true, data: topPrompts };\r\n\r\n    } catch (error) {\r\n        console.error(\"Exception in getTopPrompts:\", error);\r\n        return { success: false, error: \"Internal server error\" };\r\n    }\r\n}\r\n"],"names":[],"mappings":"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","ignoreList":[2]}