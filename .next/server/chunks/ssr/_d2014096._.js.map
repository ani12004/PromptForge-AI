{"version":3,"sources":["../../../../lib/supabaseClient.ts","../../../../app/actions/subscription.ts","../../../../app/actions/auth.ts","../../../../node_modules/%40clerk/nextjs/dist/esm/app-router/server-actions.js","../../../../lib/supabaseAdmin.ts","../../../../app/actions/gamification.ts","../../../../.next-internal/server/app/profile/page/actions.js%20%28server%20actions%20loader%29"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\"\r\n\r\n/**\r\n * Creates a Supabase client authenticated with the user's Clerk session.\r\n * \r\n * @param clerkToken - The JWT token from Clerk (await getToken({ template: 'supabase' }))\r\n */\r\nexport const createClerkSupabaseClient = (clerkToken?: string | null) => {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\n    const supabaseKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\n    return createClient(supabaseUrl, supabaseKey, {\r\n        global: {\r\n            headers: clerkToken ? { Authorization: `Bearer ${clerkToken}` } : undefined,\r\n        },\r\n    })\r\n}\r\n","\"use server\";\r\n\r\nimport { auth } from \"@clerk/nextjs/server\";\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\";\r\n\r\nexport async function getUserSubscription() {\r\n    try {\r\n        const { userId, getToken } = await auth();\r\n        if (!userId) return \"free\";\r\n\r\n        const token = await getToken({ template: \"supabase\" });\r\n        const supabase = createClerkSupabaseClient(token);\r\n\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('subscription_tier')\r\n            .eq('id', userId)\r\n            .single();\r\n\r\n        return (profile?.subscription_tier || \"free\").toLowerCase();\r\n    } catch (error) {\r\n        console.error(\"Error fetching subscription:\", error);\r\n        return \"free\";\r\n    }\r\n}\r\n","\"use server\"\r\n\r\nimport { auth } from \"@clerk/nextjs/server\"\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\"\r\n\r\nexport async function getUserRole() {\r\n    const { userId, getToken } = await auth()\r\n\r\n    if (!userId) {\r\n        return null\r\n    }\r\n\r\n    try {\r\n        const token = await getToken({ template: \"supabase\" })\r\n        const supabase = createClerkSupabaseClient(token)\r\n        const { data: profile } = await supabase\r\n            .from('profiles')\r\n            .select('role')\r\n            .eq('id', userId)\r\n            .single()\r\n\r\n        return profile?.role || 'user'\r\n    } catch (error) {\r\n        console.error(\"Failed to fetch user role\", error)\r\n        return 'user'\r\n    }\r\n}\r\n","\"use server\";\nimport { cookies } from \"next/headers\";\nasync function invalidateCacheAction() {\n  void (await cookies()).delete(`__clerk_invalidate_cache_cookie_${Date.now()}`);\n}\nexport {\n  invalidateCacheAction\n};\n","import 'server-only'\r\nimport { createClient } from '@supabase/supabase-js'\r\n\r\n/**\r\n * Creates a Supabase client with the Service Role Key.\r\n * THIS CLIENT BYPASSES ALL ROW LEVEL SECURITY (RLS).\r\n * It should ONLY be used in secure server-side contexts (e.g., Webhooks, Cron Jobs).\r\n */\r\nexport const createAdminClient = () => {\r\n    const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL\r\n    const serviceRoleKey = process.env.SUPABASE_SERVICE_ROLE_KEY\r\n\r\n    if (!supabaseUrl || !serviceRoleKey) {\r\n        throw new Error('Missing Supabase Environment Variables for Admin Client')\r\n    }\r\n\r\n    return createClient(supabaseUrl, serviceRoleKey, {\r\n        auth: {\r\n            autoRefreshToken: false,\r\n            persistSession: false\r\n        }\r\n    })\r\n}\r\n","\"use server\"\r\n\r\nimport { auth } from \"@clerk/nextjs/server\"\r\nimport { createClerkSupabaseClient } from \"@/lib/supabaseClient\"\r\nimport { createAdminClient } from \"@/lib/supabaseAdmin\"\r\nimport { Badge, UserBadge } from \"@/components/playground/types\"\r\n\r\nexport async function getBadges() {\r\n    const { userId } = await auth()\r\n    if (!userId) return { badges: [], userBadges: [] }\r\n\r\n    // Use Admin Client to bypass RLS for reading badges (fix for JWT config issues)\r\n    const supabase = createAdminClient()\r\n\r\n    // Fetch all badges\r\n    // Fetch all badges\r\n    const { data: badgesData, error: badgesError } = await supabase\r\n        .from('badges')\r\n        .select('*')\r\n\r\n    if (badgesError) {\r\n        console.error(\"Error fetching badges:\", badgesError)\r\n        return { badges: [], userBadges: [] }\r\n    }\r\n\r\n    // Sort manually by rarity weight\r\n    const RARITY_WEIGHTS: Record<string, number> = {\r\n        'Common': 1,\r\n        'Skilled': 2,\r\n        'Advanced': 3,\r\n        'Expert': 4,\r\n        'Legendary': 5\r\n    }\r\n\r\n    const badges = (badgesData as Badge[]).sort((a, b) => {\r\n        const wA = RARITY_WEIGHTS[a.rarity] || 99\r\n        const wB = RARITY_WEIGHTS[b.rarity] || 99\r\n        return wA - wB\r\n    })\r\n\r\n    console.log(`[Gamification] Fetching for user: ${userId}`)\r\n\r\n    // Fetch user's earned badges\r\n    const { data: userBadges, error: userBadgesError } = await supabase\r\n        .from('user_badges')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n\r\n    if (userBadgesError) {\r\n        console.error(\"Error fetching user badges:\", userBadgesError)\r\n    } else {\r\n        console.log(`[Gamification] Found ${userBadges?.length} badges for user ${userId}`)\r\n    }\r\n\r\n    return {\r\n        badges: (badges as Badge[]) || [],\r\n        userBadges: (userBadges as UserBadge[]) || []\r\n    }\r\n}\r\n\r\nexport async function awardBadge(badgeCondition: string) {\r\n    const { userId, getToken } = await auth()\r\n    if (!userId) return null\r\n\r\n    const token = await getToken({ template: \"supabase\" })\r\n    const supabase = createClerkSupabaseClient(token)\r\n\r\n    // 1. Find the badge by condition\r\n    const { data: badgeData } = await supabase\r\n        .from('badges')\r\n        .select('*')\r\n        .eq('unlock_condition', badgeCondition)\r\n        .single()\r\n\r\n    if (!badgeData) return null\r\n\r\n    const badge = badgeData as Badge\r\n\r\n    // 2. Check if already earned\r\n    const { data: existing } = await supabase\r\n        .from('user_badges')\r\n        .select('*')\r\n        .eq('user_id', userId)\r\n        .eq('badge_id', badge.id)\r\n        .single()\r\n\r\n    if (existing) return null // Already earned\r\n\r\n    // 3. Award Badge\r\n    const { error } = await supabase\r\n        .from('user_badges')\r\n        .insert({\r\n            user_id: userId,\r\n            badge_id: badge.id\r\n        })\r\n\r\n    if (error) {\r\n        console.error(`Failed to award badge ${badge.name}:`, error)\r\n        return null\r\n    }\r\n\r\n    return badge\r\n}\r\n\r\n// Logic to check conditions based on game events\r\n// This would be more complex in a real app, aggregating stats from a 'game_sessions' table\r\n// For this MVP, we will rely on client-side triggers or simplified server-checks\r\nexport async function checkBadgeEligibility(action: 'complete_challenge', payload: any) {\r\n    // In a robust system, we would query the DB for total stats here.\r\n    // implementation pending robust analytics\r\n    return []\r\n}\r\n","export {getUserSubscription as '0003a3dcf615081a16c914805a79b1208e05658d88'} from 'ACTIONS_MODULE0'\nexport {getUserRole as '0051101ac87c471b7462d604cadbab8a2e54996392'} from 'ACTIONS_MODULE1'\nexport {detectKeylessEnvDriftAction as '00d33c04adba09f9320585b6cd2442fddc67121317'} from 'ACTIONS_MODULE2'\nexport {invalidateCacheAction as '00fb695b95eb42dc75b9b2e7e86571a2d3342b32bb'} from 'ACTIONS_MODULE3'\nexport {createOrReadKeylessAction as '000c5950602641cd8b0661a788cb4fb705def1b4b1'} from 'ACTIONS_MODULE2'\nexport {collectKeylessMetadata as '008a5782a58bd8eba0077f5b1e478761fed9d410df'} from 'ACTIONS_MODULE4'\nexport {formatMetadataHeaders as '40e8dbb7737be346be89256c32890a354586b96faf'} from 'ACTIONS_MODULE4'\nexport {createOrReadKeylessAction as '000c5950602641cd8b0661a788cb4fb705def1b4b1'} from 'ACTIONS_MODULE2'\nexport {deleteKeylessAction as '0064afb0bd84c5266927f4777c8f0ddd5c7e626c6a'} from 'ACTIONS_MODULE2'\nexport {detectKeylessEnvDriftAction as '00d33c04adba09f9320585b6cd2442fddc67121317'} from 'ACTIONS_MODULE2'\nexport {syncKeylessConfigAction as '40efc55e4105d4adbc9874f14cc1c800be70aff8bc'} from 'ACTIONS_MODULE2'\nexport {syncKeylessConfigAction as '40efc55e4105d4adbc9874f14cc1c800be70aff8bc'} from 'ACTIONS_MODULE2'\nexport {deleteKeylessAction as '0064afb0bd84c5266927f4777c8f0ddd5c7e626c6a'} from 'ACTIONS_MODULE2'\nexport {getBadges as '005e929cf58dbc5d3d9460f531256b1ac300deeff6'} from 'ACTIONS_MODULE5'\n"],"names":[],"mappings":"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","ignoreList":[3]}